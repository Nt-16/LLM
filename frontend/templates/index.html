{% extends 'base.html' %}

{% block title %}LLMScribe - Text Editor{% endblock %}

{% block content %}
<div class="container">
    <div class="editor-container">
        {% if current_user.is_authenticated %}
            <div class="dashboard-header">
                <h1>Welcome, {{ current_user.username }}!</h1>
                {% if current_user.user_type == 'paid' %}
                <div class="dashboard-panel">
                    <div class="token-balance">
                        <i class="fas fa-coins"></i>
                        <span>{{ current_user.balance }} tokens</span>
                    </div>
                    <div class="usage-stats">
                        <div>Corrections Made: {{ correction_count }}</div>
                        <div>Words Processed: {{ word_count }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="welcome-message">
                <div class="bot-message">Welcome to LLMScribe. Please log in to get started.</div>
            </div>
        {% endif %}

        <div class="editor-area">
            <textarea id="text-input" 
                      {% if current_user.user_type == 'free' %}data-max-words="20"{% endif %}
                      placeholder="{% if current_user.user_type == 'free' %}Enter text (max 20 words){% else %}Enter your text here...{% endif %}"
                      rows="6"></textarea>
            
            <div class="action-bar">
                <button id="llm-correct" class="btn-primary">
                    <i class="fas fa-robot"></i> AI Correct
                </button>
                <span class="word-counter">0/{% if current_user.user_type == 'free' %}20{% else %}∞{% endif %}</span>
            </div>
        </div>

        <div class="correction-panel" id="correction-results">
            <!-- Correction results will appear here -->
        </div>
    </div>
</div>

<script>
document.getElementById('llm-correct').addEventListener('click', function(e) {
    e.preventDefault();
    processText('llm');
});

function processText(correctionType) {
    // Add authentication check
    {% if not current_user.is_authenticated %}
        document.getElementById('correction-results').innerHTML = 
            '<div class="bot-message error">You must be logged in to use this feature. ' +
            '<a href="{{ url_for("auth.login") }}" class="login-link">Login here</a></div>';
        return;
    {% endif %}

    const input = document.getElementById('text-input');
    const resultsPanel = document.getElementById('correction-results');
    const text = input.value.trim();
    
    if (!text) {
        alert('Please enter some text');
        return;
    }

    // Word limit enforcement
    const maxWords = input.dataset.maxWords;
    if (maxWords) {
        const wordCount = text.split(/\s+/).length;
        if (wordCount > maxWords) {
            alert(`Free users limited to ${maxWords} words`);
            return;
        }
    }

    // Show loading state
    resultsPanel.innerHTML = '<div class="bot-message">Processing your text...</div>';
    
    fetch(`/editor/${correctionType}-correct`, {  // Changed from /${correctionType}-correct
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: text,
            correction_type: correctionType
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultsPanel.innerHTML = `<div class="error-message">${data.error}</div>`;
            return;
        }

        let resultHTML = `
            <div class="correction-item">
                <div class="original-text">
                    <strong>Original:</strong> ${data.original}
                </div>
                <div class="corrected-text">
                    <strong>Corrected:</strong> ${data.corrected}
                </div>`;
        
        if (correctionType === 'llm') {
            resultHTML += `
                <div class="correction-actions">
                    <button class="btn-accept">Accept</button>
                    <button class="btn-reject">Reject</button>
                </div>`;
        }
        
        resultHTML += `</div>`;
        resultsPanel.innerHTML = resultHTML;
    })
    .catch(error => {
        console.error('Error:', error);
        resultsPanel.innerHTML = '<div class="error-message">Error processing request</div>';
    });
}

// Enhanced word counter with limit enforcement
document.getElementById('text-input').addEventListener('input', function(e) {
    const maxWords = this.dataset.maxWords || Infinity;
    const words = this.value.trim().split(/\s+/);
    const wordCounter = document.querySelector('.word-counter');
    
    // Handle empty input
    if (this.value.trim() === '') {
        wordCounter.textContent = `0/${maxWords !== Infinity ? maxWords : '∞'}`;
        return;
    }

    // Enforce word limit
    if (words.length > maxWords) {
        this.value = words.slice(0, maxWords).join(' ');
        words.length = maxWords;
        wordCounter.classList.add('limit-reached');
        alert(`Free users limited to ${maxWords} words`);
    } else {
        wordCounter.classList.remove('limit-reached');
    }

    // Update counter display
    wordCounter.textContent = `${words.length}/${maxWords !== Infinity ? maxWords : '∞'}`;
});
</script>
{% endblock %}